\batchmode
% file: xjupiter-tla.tex

\documentclass{article}
\usepackage{graphicx}
\usepackage{tlatex}
\usepackage{color}
\definecolor{boxshade}{gray}{.85}
\setboolean{shading}{true}

\begin{document}
\makeatletter
\chardef\%=`\%
\fl{}\moduleLeftDash\cl{ {\MODULE} XJupiter}\moduleRightDash\cl{}
\fl{ {\VARIABLES}}\al{1}{1}{ c2ss ,\,}\al{1}{3}{%
\@y{%
  $c2ss[c]$: the $2D$ digraph maintained at client $c$ 
}%
}
\fl{ s2ss}\al{2}{1}{%
\@y{%
  $s2ss[c]$: the $2D$ digraph maintained by the $Server$ for client $c$
}%
}
\fl{}\midbar\cl{}
\fl{ NextEdge ( r ,\, u ,\, g ) \.{\defeq}%
\@y{%
  Return the \emph{unique} outgoing edge from $u$ in $2D$ digraph $g$ 
}%
}
\fl{ {\CHOOSE} e \.{\in} g . edge \.{:} e . from \.{=} u%
\@y{%
  ($r$ is not used). 
}%
}
 \fl{ CPerform ( c ,\, cop ) \.{\defeq}}\al{6}{7}{ \.{\LET}}\al{6}{8}{ xform
 \.{\defeq} xForm ( NextEdge ,\, c ,\, cop ,\, c2ss [ c ] )}
 \fl{ \.{\IN}}\al{7}{1}{ \.{\land}}\al{7}{2}{ c2ss \.{'}}\al{7}{4}{
 \.{=}}\al{7}{5}{ [ c2ss {\EXCEPT} {\bang} [ c ]}\al{7}{12}{
 \.{=}}\al{7}{13}{ @ \.{\oplus} xform . xg ]}
 \fl{ \.{\land}}\al{8}{1}{ list \.{'}}\al{8}{3}{ \.{=}}\al{8}{4}{ [ list
 {\EXCEPT} {\bang} [ c ]}\al{8}{11}{ \.{=}}\al{8}{12}{ Apply ( xform . xcop .
 op ,\, @ ) ]}
 \fl{ Do ( c ,\, op ) \.{\defeq}}\al{9}{7}{ \.{\LET}}\al{9}{8}{ cop \.{\defeq}
 [ op \.{\mapsto} op ,\, oid \.{\mapsto} [ c \.{\mapsto} c ,\, seq
 \.{\mapsto} cseq [ c ] ] ,\, ctx \.{\mapsto} ds [ c ] ]}
\fl{ \.{\IN}}\al{10}{1}{ \.{\land}}\al{10}{2}{ CPerform ( c ,\, cop )}
\fl{ \.{\land}}\al{11}{1}{%
\@y{%
  send $cop$ to the $Server$
}%
}
\fl{ Rev ( c ,\, cop ) \.{\defeq} CPerform ( c ,\, cop )}
\fl{ SRev}\al{13}{1}{ ( cop )}\al{13}{4}{ \.{\defeq}}
\fl{ \.{\LET} c}\al{14}{2}{ \.{\defeq} ClientOf ( cop )}
 \fl{ xform}\al{15}{1}{ \.{\defeq} xForm ( NextEdge ,\, Server ,\, cop ,\,
 s2ss [ c ] )%
\@y{%
  $xform$: $[xcop, xg, lg]$
}%
}
 \fl{ \.{\IN}}\al{16}{1}{ \.{\land}}\al{16}{2}{ s2ss \.{'}}\al{16}{4}{
 \.{=}}\al{16}{5}{ [ cl \.{\in} Client \.{\mapsto} {\IF} cl \.{=}
 c}\al{16}{14}{ \.{\THEN} s2ss [ cl ]}\al{16}{19}{ \.{\oplus}}\al{16}{20}{
 xform . xg}
\fl{ \.{\ELSE} s2ss [ cl ]}\al{17}{5}{ \.{\oplus}}\al{17}{6}{ xform . lg ]}
 \fl{ \.{\land}}\al{18}{1}{ list \.{'}}\al{18}{3}{ \.{=}}\al{18}{4}{ [ list
 {\EXCEPT} {\bang} [ Server ] \.{=} Apply ( xform . xcop . op ,\, @ ) ]}
\fl{ \.{\land}}\al{19}{1}{%
\@y{%
 broadcast the {\it transformed operation} $xform.xcop$ to clients other
 than $c$
}%
}
\fl{}\bottombar\cl{}
\end{document}
